<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PUZZLE BATTLE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="https://png.pngtree.com/png-clipart/20240927/original/pngtree-colorful-glass-ball-png-image_16108516.png" sizes="16√ó16" type="image/png" />  
<style>
body{
  margin:0;background:#111;color:#fff;font-family:sans-serif;
  display:flex;flex-direction:column;align-items:center;
  overflow:hidden;
}
#top{
  width:100%;display:flex;justify-content:space-between;
  padding:8px;background:#222;font-size:14px;
}
.bar{width:100px;height:10px;background:#333;border-radius:8px;overflow:hidden}
.bar div{height:100%;background:linear-gradient(90deg,#0f0,#6f6)}
#enemyBar div{background:linear-gradient(90deg,#f44,#a00)}

#turnText{
  position:fixed;top:40%;width:100%;text-align:center;
  font-size:48px;font-weight:bold;opacity:0;
  pointer-events:none;transition:.4s;z-index:10;
}
.turn-player{color:#4af;text-shadow:0 0 20px #4af;}
.turn-enemy{color:#f44;text-shadow:0 0 20px #f44;}

#board{
  width:90vw;max-width:360px;
  aspect-ratio:6/5;
  display:grid;
  grid-template-columns:repeat(6,1fr);
  grid-template-rows:repeat(5,1fr);
  gap:4px;
  margin-top:10px;
}
.orb{
  border-radius:50%;
  box-shadow:inset -3px -3px 6px rgba(0,0,0,.4),
             inset 3px 3px 6px rgba(255,255,255,.4);
}

.fire{background:#f55}
.water{background:#59f}
.wood{background:#5f5}
.light{background:#ff5}
.dark{background:#b5f}

#result{
  position:fixed;inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

button{
  padding:8px 16px;border:none;border-radius:20px;
  background:#444;color:white;margin:6px;
}
</style>
</head>
<body>

<div id="top">
  <div>HP<div class="bar"><div id="hpBar"></div></div></div>
  <div>TURN <span id="turn">1</span></div>
  <div>ENEMY<div class="bar" id="enemyBar"><div></div></div></div>
</div>

<div id="turnText"></div>
<div id="board"></div>

<div style="margin:10px">
  <button onclick="saveGame()">üíæSAVE</button>
  <button onclick="loadGame()">üìÇLOAD</button>
</div>

<div id="result">
  <h1 id="resultText"></h1>
  <button onclick="location.reload()">RETRY</button>
</div>

<script>
/* ===== Âü∫Êú¨Ë®≠ÂÆö ===== */
const ROW=5,COL=6;
const colors=["fire","water","wood","light","dark"];

let board=[];
let turn=1;
let timer=15;
let playerHP=100;
let enemyHP=100;
let combo=0;
let healCount=0;
let timerRunning=false;
let dragging=false;
let startPos=null;

/* ===== ÂàùÊúüÂåñ ===== */
function init(){
  board=[];
  for(let r=0;r<ROW;r++){
    board[r]=[];
    for(let c=0;c<COL;c++){
      board[r][c]=colors[Math.floor(Math.random()*5)];
    }
  }
  enemyHP=100+turn*20;
  updateUI();
  draw();
  startTurn();
}
init();

/* ===== ÊèèÁîª ===== */
function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  for(let r=0;r<ROW;r++){
    for(let c=0;c<COL;c++){
      const d=document.createElement("div");
      d.className="orb "+board[r][c];
      d.dataset.r=r;
      d.dataset.c=c;
      b.appendChild(d);
    }
  }
}

/* ===== UI ===== */
function updateUI(){
  document.getElementById("hpBar").style.width=playerHP+"%";
  document.querySelector("#enemyBar div").style.width=enemyHP+"%";
  document.getElementById("turn").textContent=turn;
}

/* ===== „Çø„Éº„É≥ÊºîÂá∫ ===== */
function showTurn(text,type){
  const t=document.getElementById("turnText");
  t.textContent=text;
  t.className=type==="player"?"turn-player":"turn-enemy";
  t.style.opacity=1;
  setTimeout(()=>t.style.opacity=0,900);
}

/* ===== „Çø„Éº„É≥ÁÆ°ÁêÜ ===== */
function startTurn(){
  showTurn("YOUR TURN","player");
  timer=15;
  timerRunning=true;
  tick();
}
function tick(){
  if(!timerRunning) return;
  setTimeout(()=>{
    timer--;
    if(timer<=0){
      timerRunning=false;
      enemyTurn();
    }else tick();
  },1000);
}

/* ===== Êïµ„Çø„Éº„É≥ ===== */
function enemyTurn(){
  showTurn("ENEMY TURN","enemy");
  setTimeout(()=>{
    let dmg=15+turn*2;
    playerHP-=dmg;
    if(playerHP<=0){
      gameOver();
      return;
    }
    turn++;
    if(turn%3===0){ // ÂõûÂæ©„Çπ„Ç≠„É´
      playerHP=Math.min(100,playerHP+20);
    }
    startTurn();
    updateUI();
  },1000);
}

/* ===== ÂÖ•ÂäõÂá¶ÁêÜ ===== */
document.addEventListener("pointerdown",e=>{
  if(!e.target.classList.contains("orb")) return;
  dragging=true;
  startPos={r:+e.target.dataset.r,c:+e.target.dataset.c};
});
document.addEventListener("pointermove",e=>{
  if(!dragging) return;
  const t=document.elementFromPoint(e.clientX,e.clientY);
  if(!t||!t.classList.contains("orb"))return;
  let r=+t.dataset.r,c=+t.dataset.c;
  if(Math.abs(r-startPos.r)+Math.abs(c-startPos.c)===1){
    [board[r][c],board[startPos.r][startPos.c]]=
    [board[startPos.r][startPos.c],board[r][c]];
    startPos={r,c};
    draw();
  }
});
document.addEventListener("pointerup",()=>{
  dragging=false;
  checkMatch();
});

/* ===== „Éû„ÉÉ„ÉÅÂá¶ÁêÜ ===== */
function checkMatch(){
  let del=[];
  for(let r=0;r<ROW;r++){
    for(let c=0;c<COL-2;c++){
      if(board[r][c]&&board[r][c]==board[r][c+1]&&board[r][c]==board[r][c+2])
        del.push([r,c],[r,c+1],[r,c+2]);
    }
  }
  for(let c=0;c<COL;c++){
    for(let r=0;r<ROW-2;r++){
      if(board[r][c]&&board[r][c]==board[r+1][c]&&board[r][c]==board[r+2][c])
        del.push([r,c],[r+1,c],[r+2,c]);
    }
  }

  if(!del.length) return;

  combo++;
  enemyHP-=del.length*3;

  del.forEach(([r,c])=>board[r][c]=null);
  fall();
  updateUI();
  setTimeout(checkMatch,200);
}

/* ===== ËêΩ‰∏ã ===== */
function fall(){
  for(let c=0;c<COL;c++){
    for(let r=ROW-1;r>=0;r--){
      if(!board[r][c]){
        for(let rr=r-1;rr>=0;rr--){
          if(board[rr][c]){
            board[r][c]=board[rr][c];
            board[rr][c]=null;
            break;
          }
        }
        if(!board[r][c]) board[r][c]=colors[Math.floor(Math.random()*5)];
      }
    }
  }
  draw();
}

/* ===== „Çª„Éº„Éñ ===== */
function saveGame(){
  localStorage.setItem("pzl_save",JSON.stringify({
    turn,playerHP,enemyHP,board
  }));
}
function loadGame(){
  const d=JSON.parse(localStorage.getItem("pzl_save"));
  if(!d) return;
  turn=d.turn;playerHP=d.playerHP;enemyHP=d.enemyHP;board=d.board;
  updateUI();draw();
}

/* ===== ÁµÇ‰∫Ü ===== */
function gameOver(){
  document.getElementById("result").style.display="flex";
  document.getElementById("resultText").textContent="GAME OVER";
}
</script>
</body>
</html>
