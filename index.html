<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PUZZLE BATTLE ULTIMATE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="icon" href="https://png.pngtree.com/png-clipart/20240927/original/pngtree-colorful-glass-ball-png-image_16108516.png" sizes="16√ó16" type="image/png" />  
<style>
*{box-sizing:border-box;touch-action:none;}
body{
  margin:0;background:#111;color:#fff;
  font-family:sans-serif;overflow:hidden;
}
#top{
  display:flex;justify-content:space-between;
  padding:6px;background:#222;font-size:14px;
}
.bar{width:110px;height:10px;background:#333;border-radius:10px;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(to right,#0f0,#6f6)}
#enemyBar>div{background:linear-gradient(to right,#f33,#a00)}

#timer{text-align:center;font-size:18px;margin:4px}

#board{
  width:95vw;max-width:420px;height:360px;
  margin:auto;
  display:grid;
  grid-template-columns:repeat(6,1fr);
  grid-template-rows:repeat(5,1fr);
  gap:4px;
}

.orb{
  position: relative;
  width:100%;
  height:100%;
  border-radius:50%;
  backdrop-filter: blur(4px);
  background: rgba(255,255,255,0.15);
  box-shadow:
    inset 0 0 10px rgba(255,255,255,0.6),
    inset -6px -6px 10px rgba(0,0,0,0.3),
    0 4px 8px rgba(0,0,0,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  color:white;
  text-shadow:0 0 6px rgba(255,255,255,.8);
  transition:transform .1s, filter .1s;
}

.orb:active{
  transform:scale(0.92);
  filter:brightness(1.3);
}

/* Â±ûÊÄß„Ç´„É©„Éº */
.fire  { background:linear-gradient(135deg,#ff5a5a,#ff9966); }
.water { background:linear-gradient(135deg,#4facfe,#00f2fe); }
.wood  { background:linear-gradient(135deg,#43e97b,#38f9d7); }
.light { background:linear-gradient(135deg,#fff7a1,#ffe066); }
.dark  { background:linear-gradient(135deg,#a18cd1,#6f42c1); }

/* ÂÖâÊ≤¢ */
.orb::after{
  content:"";
  position:absolute;
  top:8%;
  left:12%;
  width:40%;
  height:40%;
  border-radius:50%;
  background:rgba(255,255,255,0.35);
  filter:blur(4px);
}
@keyframes pulse{
  0%{filter:brightness(1)}
  50%{filter:brightness(1.6)}
  100%{filter:brightness(1)}
}

#combo{
  position:absolute;
  top:70px;width:100%;
  text-align:center;
  font-size:40px;
  color:gold;
  opacity:0;
  transition:.3s;
}

#turnText{
  position:fixed;
  top:40%;
  width:100%;
  text-align:center;
  font-size:48px;
  font-weight:bold;
  opacity:0;
  pointer-events:none;
  transition:.4s;
}
.turn-player{color:#4af;text-shadow:0 0 20px #4af;}
.turn-enemy{color:#f44;text-shadow:0 0 20px #f44;}

#result{
  position:fixed;inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  justify-content:center;
  align-items:center;
  text-align:center;
}

button{
  padding:10px 16px;
  border-radius:20px;
  border:none;
  background:#333;
  color:#fff;
}
</style>
</head>
<body>

<div id="top">
  <div>HP<div class="bar"><div id="hp"></div></div></div>
  <div>STAGE <span id="stage">1</span></div>
  <div>ENEMY<div class="bar" id="enemyBar"><div id="enemy"></div></div></div>
</div>

<div id="timer">TIME: 30</div>
<div id="combo"></div>
<div id="turnText"></div>
<div id="board"></div>

<div style="text-align:center">
  <button onclick="saveGame()">üíæ SAVE</button>
  <button onclick="deleteSave()">üóë RESET</button>
</div>

<div id="result">
  <div>
    <h2 id="resultText"></h2>
    <button onclick="location.reload()">RETRY</button>
  </div>
</div>

<script>
const ROW=5,COL=6;
const colors=["fire","water","wood","light","dark"];
const SAVE_KEY="PUZZLE_ULTIMATE_SAVE";

let board=[],drag=false,last=null;
let stage=1,playerHP=100,enemyHP=100;
let combo=0,timer=30,timerOn=false;
let enemyType="normal";

/* ---------- ÂàùÊúüÂåñ ---------- */
function init(){
  board=[];
  for(let r=0;r<ROW;r++){
    board[r]=[];
    for(let c=0;c<COL;c++) board[r][c]=rand();
  }
  newEnemy();
  draw();updateUI();
}

/* ---------- Êïµ ---------- */
function newEnemy(){
  enemyHP=100+stage*30;
  enemyType=stage%5===0?"boss":"normal";
}

/* ---------- ÊèèÁîª ---------- */
function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  for(let r=0;r<ROW;r++)for(let c=0;c<COL;c++){
    const d=document.createElement("div");
    d.className="orb "+board[r][c]+(enemyType==="boss"?" boss":"");
    d.dataset.r=r; d.dataset.c=c;
    b.appendChild(d);
  }
}

/* ---------- ÂÖ•Âäõ ---------- */
document.addEventListener("pointerdown",e=>{
  if(!e.target.classList.contains("orb"))return;
  drag=true;
  last={r:+e.target.dataset.r,c:+e.target.dataset.c};
  if(!timerOn){startTurn();}
});
document.addEventListener("pointermove",e=>{
  if(!drag)return;
  const t=document.elementFromPoint(e.clientX,e.clientY);
  if(!t||!t.classList.contains("orb"))return;
  let r=+t.dataset.r,c=+t.dataset.c;
  if(Math.abs(r-last.r)+Math.abs(c-last.c)==1){
    [board[r][c],board[last.r][last.c]]=[board[last.r][last.c],board[r][c]];
    last={r,c};
    draw();
  }
});
document.addEventListener("pointerup",()=>{drag=false;check();});

/* ---------- „Çø„Éº„É≥ ---------- */
function startTurn(){
  timerOn=true;
  timer=30;
  showTurn("YOUR TURN","player");
  startTimer();
}
function showTurn(text,type){
  const t=document.getElementById("turnText");
  t.textContent=text;
  t.className=type==="player"?"turn-player":"turn-enemy";
  t.style.opacity=1;
  setTimeout(()=>t.style.opacity=0,800);
}

/* ---------- Âà§ÂÆö ---------- */
function check(){
  let del=[];
  for(let r=0;r<ROW;r++)for(let c=0;c<COL-2;c++)
    if(board[r][c]==board[r][c+1]&&board[r][c]==board[r][c+2])
      del.push([r,c],[r,c+1],[r,c+2]);
  for(let c=0;c<COL;c++)for(let r=0;r<ROW-2;r++)
    if(board[r][c]==board[r+1][c]&&board[r][c]==board[r+2][c])
      del.push([r,c],[r+1,c],[r+2,c]);

  if(!del.length){combo=0;return;}

  combo++;
  enemyHP -= del.length*5;
  del.forEach(p=>board[p[0]][p[1]]=null);
  fall(); showCombo(); updateUI();

  if(enemyHP<=0){stage++; newEnemy();}
  saveGame();
  setTimeout(check,150);
}

/* ---------- ËêΩ‰∏ã ---------- */
function fall(){
  for(let c=0;c<COL;c++){
    for(let r=ROW-1;r>=0;r--){
      if(!board[r][c]){
        for(let rr=r-1;rr>=0;rr--){
          if(board[rr][c]){
            board[r][c]=board[rr][c];
            board[rr][c]=null;
            break;
          }
        }
        if(!board[r][c]) board[r][c]=rand();
      }
    }
  }
  draw();
}

/* ---------- „Çø„Ç§„Éû„Éº ---------- */
function startTimer(){
  const t=setInterval(()=>{
    timer--;
    document.getElementById("timer").textContent="TIME: "+timer;
    if(timer<=0){
      clearInterval(t);
      enemyTurn();
    }
  },1000);
}

function enemyTurn(){
  showTurn("ENEMY TURN","enemy");
  setTimeout(()=>{
    let dmg=enemyType==="boss"?25:15;
    playerHP-=dmg;
    document.body.style.background="#400";
    setTimeout(()=>document.body.style.background="#111",200);
    if(playerHP<=0){
      gameOver();
    }else{
      timer=30;
      timerOn=false;
    }
  },700);
}

/* ---------- UI ---------- */
function showCombo(){
  const c=document.getElementById("combo");
  c.textContent=combo+" COMBO!";
  c.style.opacity=1;
  setTimeout(()=>c.style.opacity=0,400);
}
function updateUI(){
  document.getElementById("hp").style.width=playerHP+"%";
  document.getElementById("enemy").style.width=enemyHP+"%";
  document.getElementById("stage").textContent=stage;
}

/* ---------- ÁµÇ‰∫Ü ---------- */
function gameOver(){
  document.getElementById("result").style.display="flex";
  document.getElementById("resultText").textContent="GAME OVER";
}

/* ---------- „Çª„Éº„Éñ ---------- */
function saveGame(){
  localStorage.setItem(SAVE_KEY,JSON.stringify({
    board,stage,playerHP,enemyHP,timer
  }));
}
function deleteSave(){
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}
function loadGame(){
  const d=JSON.parse(localStorage.getItem(SAVE_KEY));
  if(!d)return false;
  board=d.board;stage=d.stage;
  playerHP=d.playerHP;enemyHP=d.enemyHP;
  timer=d.timer;
  draw();updateUI();
  return true;
}

function rand(){return colors[Math.floor(Math.random()*colors.length)]}

/* Ëµ∑Âãï */
if(!loadGame()) init();
</script>
</body>
</html>
